df$tiempo[df$round==r]<-df$tiempo[df$round==r]+max(df$tiempo[df$round==r-1])
dt$tiempo[dt$round==r]<-dt$tiempo[dt$round==r]+max(df$tiempo[df$round==r-1])
#df$time_inactive[df$round==r]<-df$time_inactive[df$round==r]+max(df$tiempo[df$round==r-1])
}
for(r in 2:length(unique(df$round))){
df$time_inactive[df$round==r]<-df$time_inactive[df$round==r]+max(df$tiempo[df$round==r-1])
}
dt$tre<-2
dt$session<-unlist(strsplit(nombre, split='.', fixed=TRUE))[1]
d_pcodes<- df %>% select(id,pcode)
dt<- dt %>% inner_join(d_pcodes, by = c("make_id" = "id"))
colnames(dt)[10] = "make_pcode"
dt<- dt %>% inner_join(d_pcodes, by = c("take_id" = "id"))
colnames(dt)[11] = "take_pcode"
d_bid<- df %>% select(id,bid)
dt<- dt %>% inner_join(d_bid, by = c("make_id" = "id"))
colnames(dt)[12] = "make_isbid"
save(df,file=paste("data_",df$session[1],".Rda",sep=""))
save(dt,file=paste("datatrades_",dt$session[1],".Rda",sep=""))
setwd("~/Desktop/jotarepos/capmout/clean")
#setwd("~/Desktop/jotarepos/capmout/a2c/clean")
files<-list.files(pattern="data_")
d<-NULL
for (f in files){
load(f)
d<-rbind(d,df)
}
files_t<-list.files(pattern="datatrades*")
dd<-NULL
for (f in files_t){
load(f)
dd<-rbind(dd,dt)
}
#load("~/Desktop/jotarepos/capm/Data/alldata.Rda")
save(d,file="alldata.Rda")
save(dd,file="alltrades.Rda")
rm(list = ls())
library(dplyr)
library(tidyverse)
library(xtable)
load("~/Desktop/jotarepos/capmout/clean/alldata.Rda")
d <- arrange(d, d$session, d$round, d$tiempo)
d$time_inactive[d$time_inactive>86400 & !is.na(d$time_inactive)]<-d$time_inactive[d$time_inactive>86400  & !is.na(d$time_inactive)]-86400
#d$time_inactive[d$time_inactive>86400 & !is.na(d$time_inactive)]<-d$time_inactive[d$time_inactive>86400  & !is.na(d$time_inactive)]-86400
#d$ex_price[!is.na(d$ex_price) & (d$time_inactive-d$tiempo>0.8)]<-NA
d$bb<-NA
d$bo<-NA
#d$ex_price[!is.na(d$ex_price) & (d$time_inactive-d$tiempo>0.8)]<-NA
for(sess in unique(d$session)){
for(activo in c(1:4)){
for(r in c(1:7)){
books<- d %>% filter(round==r &session==sess & asset==activo) %>% select(price, tiempo, time_inactive, bid, ex_price, status)
books$bb<-NA
books$bo<-NA
books$price[!is.na(books$ex_price)]<-books$ex_price[!is.na(books$ex_price)]
books$price[books$bid==FALSE]<-books$price[books$bid==FALSE]*-1
books$time_inactive[is.na(books$time_inactive)]<-max(books$tiempo)+10
books$time_inactive[books$status=="ACCEPTED_TAKER"]<-books$tiempo[books$status=="ACCEPTED_TAKER"]
for(l in c(1:dim(books)[1])){
t<-books$tiempo[l]
books$bb[l]<-max(books$price[books$tiempo<=t & books$time_inactive>=t])
}
books$price[books$bid==FALSE]<-books$price[books$bid==FALSE]*-1
books$price[books$bid==TRUE]<-10000
for(l in c(1:dim(books)[1])){
t<-books$tiempo[l]
books$bo[l]<-min(books$price[books$tiempo<=t & books$time_inactive>=t],na.rm=T)
}
d$bb[d$round==r &d$session==sess & d$asset==activo]<- books$bb
d$bo[d$round==r &d$session==sess & d$asset==activo]<- books$bo
}
}
}
d<-as.data.frame(d)
d$bb<-as.numeric(paste(d$bb))
d$bo<-as.numeric(paste(d$bo))
d$ex_price<-as.numeric(paste(d$ex_price))
d$price<-as.numeric(paste(d$price))
d$bb[d$bb<0]<-NA
d$bo[d$bo==10000]<-NA
d$spd<-(d$bo-d$bb)
d$spd_z<-d$spd
d$spd_z[is.na(d$spd_z)]<-0
rango<- 4
descuento<- 0.99
data<-NULL
for(sess in unique(d$session)){
tre<-max(d$tre[d$session==sess])
precio<-NA
for(r in c(1:7)){
t_0<-min(d$tiempo[d$round==r & d$session==sess])
t_max<-max(d$tiempo[d$round==r & d$session==sess])
precio<-NA
dete<-0
dete_a<-0
for(activo in c(1:4)){
i<-0
precio<-NA
dete<-0
dete_a<-0
books<- d %>% filter(round==r &session==sess & asset==activo) %>% select(price, tiempo, time_inactive, bid, ex_price, status)
books$price[!is.na(books$ex_price)]<-books$ex_price[!is.na(books$ex_price)]
books$time_inactive[is.na(books$time_inactive)]<-max(books$tiempo)+10
books$time_inactive[books$status=="ACCEPTED_TAKER"]<-books$tiempo[books$status=="ACCEPTED_TAKER"]
l<-t_0+rango
while (l<=t_max){
i<-i+1
descuento_compra<-0
ordenes_compra<-0
ordenes_venta<-0
dete<-0
precio<-NA
spr<-0
bb<-NA
bo<-NA
libro<- books %>% filter(tiempo<=l & time_inactive>l-rango)
if(dim(libro)[1]>0){
libro_compra<- libro %>% filter(bid==TRUE)
libro_venta<-  libro %>% filter(bid==FALSE)
if(dim(libro_compra)[1]>0){
bb<-max(libro_compra$price)
}
if(dim(libro_venta)[1]>0){
bo<-min(libro_venta$price)
}
spr<-mean(c(bo,bb),na.rm = T)
if(dim(libro_compra)[1]>0){
ordenes_compra<-sum(descuento^(abs(libro_compra$price-spr)),na.rm=T)
}
if(dim(libro_venta)[1]>0){
ordenes_venta<-sum(descuento^(abs(libro_venta$price-spr)),na.rm=T)
}
precio<-mean(libro$ex_price[(libro$time_inactive-libro$tiempo<1)],na.rm = T)
if (!is.na(precio)){
dete<-length(libro$ex_price[libro$time_inactive-libro$tiempo<1 & libro$bid==TRUE])- length(libro$ex_price[libro$time_inactive-libro$tiempo<1 & libro$bid!=TRUE])
dete_a<-dete_a+dete
}
data<-rbind(data,cbind(sess,tre,r,activo,i,ordenes_compra,ordenes_venta,bb,bo,precio,dete,dete_a))
}
l<-l+rango
}
}
}
}
data<-as.data.frame(data)
data$bb<-as.numeric(paste(data$bb))
data$bo<-as.numeric(paste(data$bo))
data$dete<-as.numeric(paste(data$dete))
data$dete_a<-as.numeric(paste(data$dete_a))
data$i<-as.numeric(paste(data$i))
data$activo<-as.numeric(paste(data$activo))
data$r<-as.numeric(paste(data$r))
data$tre<-as.numeric(paste(data$tre))
data$ordenes_compra<-as.numeric(paste(data$ordenes_compra))
data$ordenes_venta<-as.numeric(paste(data$ordenes_venta))
data$z<-data$ordenes_compra-data$ordenes_venta
data$precio<-as.numeric(paste(data$precio))
data <- arrange(data, data$sess, data$activo, data$r, data$i)
data$dt[2:length(data$r)]<-data$r[2:length(data$r)]-data$r[1:length(data$r)-1]
data$dt[1]<-0
write.csv(data,file="detf.csv",row.names=FALSE)
library(dplyr)
library(tidyverse)
library(xtable)
library(here)
d<-read.csv(here("detf.csv"),sep=",",header=T, stringsAsFactors = FALSE)
dprice<- d %>%
group_by(sess, tre, r, activo)  %>%
summarize(prices=  mean(precio,na.rm = T))
plot(dprice$prices[dprice$activo==2 & dprice$tre==1],dprice$prices[dprice$activo==3 & dprice$tre==1] )
abline(0,1)
points(dprice$prices[dprice$activo==2 & dprice$tre==2],dprice$prices[dprice$activo==3 & dprice$tre==2],col="blue")
points(dprice$prices[dprice$activo==2 & dprice$tre==3],dprice$prices[dprice$activo==3 & dprice$tre==3],col="red")
dprice2<- d %>%
group_by(tre, r, activo)  %>%
summarize(prices=  mean(precio,na.rm = T),
ordenes= mean(z,na.rm = T)
)
pdf("sum_prices.pdf")
plot(dprice2$r[dprice2$activo==2 & dprice2$tre==1],dprice2$prices[dprice2$activo==3 & dprice2$tre==1]-dprice2$prices[dprice2$activo==2 & dprice2$tre==1],type="l",ylim=c(-10,40),xlab="market",ylab=expression('P'[C] - 'P'[B]),lwd=2)
lines(dprice2$r[dprice2$activo==2 & dprice2$tre==2],dprice2$prices[dprice2$activo==3 & dprice2$tre==2]-dprice2$prices[dprice2$activo==2 & dprice2$tre==2],col="blue",lwd=2,lty=2)
lines(dprice2$r[dprice2$activo==2 & dprice2$tre==3],dprice2$prices[dprice2$activo==3 & dprice2$tre==3]-dprice2$prices[dprice2$activo==2 & dprice2$tre==3],col="red",lwd=2,lty=3)
abline(h=0,lty=2,col="gray")
legend(1.1,19,c("ABC","A2C","A2C short"),col=c("black", "blue","red"),lty=c(1,2,3),cex=.9,bty = "n")
dev.off()
View(d)
pdf("sum_ordenes.pdf")
plot(dprice2$r[dprice2$activo==2 & dprice2$tre==1],dprice2$ordenes[dprice2$activo==3 & dprice2$tre==1]-dprice2$ordenes[dprice2$activo==2 & dprice2$tre==1],type="l",ylim=c(-2,5),xlab="market",ylab=expression('z'[C] - 'z'[B]),lwd=2)
lines(dprice2$r[dprice2$activo==2 & dprice2$tre==2],dprice2$ordenes[dprice2$activo==3 & dprice2$tre==2]-dprice2$ordenes[dprice2$activo==2 & dprice2$tre==2],col="blue",lwd=2,lty=2)
lines(dprice2$r[dprice2$activo==2 & dprice2$tre==3],dprice2$ordenes[dprice2$activo==3 & dprice2$tre==3]-dprice2$ordenes[dprice2$activo==2 & dprice2$tre==3],col="red",lwd=2,lty=3)
abline(h=0,lty=2,col="gray")
legend(5,4,c("ABC","A2C","A2C short"),col=c("black", "blue","red"),lty=c(1,2,3),cex=.9,bty = "n")
dev.off()
rm(list = ls())
library(dplyr)
library(tidyverse)
library(xtable)
library(here)
load("~/Desktop/jotarepos/capmout/clean/alltrades.Rda")
dd[["isBot"]] <- grepl("Bot", dd[["make_pcode"]]) | grepl("Bot", dd[["take_pcode"]])
dd[["maker_isBot"]] <- grepl("Bot", dd[["make_pcode"]])
dd[["taker_isBot"]] <- grepl("Bot", dd[["take_pcode"]])
write.csv(dd,file="dtrades.csv",row.names=FALSE)
table(dd$asset,dd$isBot)
bot_d <- filter(dd, asset==4)
bot_bought_d <- sum(bot_d  %>% filter(maker_isBot==TRUE & make_isbid ==TRUE ) %>% select(ex_price))
bot_bought_d2 <- sum(bot_d  %>% filter(taker_isBot==TRUE & make_isbid ==FALSE ) %>% select(ex_price))
bot_sold_d <- sum(bot_d  %>% filter(maker_isBot==TRUE & make_isbid ==FALSE ) %>% select(ex_price))
bot_sold_d2 <- sum(bot_d  %>% filter(taker_isBot==TRUE & make_isbid ==TRUE ) %>% select(ex_price))
bot_u <- filter(dd, asset!=4)
bot_bought_u <- sum(bot_u  %>% filter(maker_isBot==TRUE & make_isbid ==TRUE ) %>% select(ex_price))
bot_bought_u2 <- sum(bot_u  %>% filter(taker_isBot==TRUE & make_isbid ==FALSE ) %>% select(ex_price))
bot_sold_u <- sum(bot_u  %>% filter(maker_isBot==TRUE & make_isbid ==FALSE ) %>% select(ex_price))
bot_sold_u2 <- sum(bot_u %>% filter(taker_isBot==TRUE & make_isbid ==TRUE ) %>% select(ex_price))
profits_bot <- (bot_sold_d+bot_sold_d2-bot_bought_u-bot_bought_u)+bot_sold_u+bot_sold_u2-bot_bought_d-bot_bought_d2
profits_bot/(length(unique(dd$session))*7)
mean(dd$ex_price[dd$asset==3 & dd$round>5])-mean(dd$ex_price[dd$asset==2& dd$round>5])
sum(dd$ex_price[dd$asset==4 & dd$isBot==TRUE])
sum(dd$ex_price[dd$asset!=4& dd$isBot==TRUE])
View(dd)
View(dd)
mean(dd$ex_price[dd$asset==3 & dd$session=='5c09zarp' & dd$round>5])
mean(dd$ex_price[dd$asset==2 & dd$session=='5c09zarp' & dd$round>5])
table(dd$round)
mean(dd$ex_price[dd$asset==3 & dd$session=='5c09zarp' ])
mean(dd$ex_price[dd$asset==2 & dd$session=='5c09zarp'])
mean(dd$ex_price[dd$asset==3 & dd$session=='5c09zarp' & dd$round>4])
mean(dd$ex_price[dd$asset==2 & dd$session=='5c09zarp' & dd$round>4])
mean(dd$ex_price[dd$asset==3 & dd$isBot==FALSE & dd$session=='5c09zarp' & dd$round>4])
mean(dd$ex_price[dd$asset==2 & dd$isBot==FALSE & dd$session=='5c09zarp' & dd$round>4])
mean(dd$ex_price[dd$asset==3 & dd$isBot==TRUE & dd$session=='5c09zarp' & dd$round>4])
mean(dd$ex_price[dd$asset==2 & dd$isBot==TRUE & dd$session=='5c09zarp' & dd$round>4])
mean(dd$ex_price[dd$asset==3 & dd$isBot==TRUE & dd$session=='5c09zarp'])
mean(dd$ex_price[dd$asset==2 & dd$isBot==TRUE & dd$session=='5c09zarp'])
mean(dd$ex_price[dd$asset==2 & dd$isBot==FALSE & dd$session=='5c09zarp'])
mean(dd$ex_price[dd$asset==3 & dd$isBot==TRUE & dd$session=='5c09zarp'])
mean(dd$ex_price[dd$asset==3 & dd$isBot==TRUE & dd$session=='5c09zarp'])
mean(dd$ex_price[dd$asset==3 & dd$isBot==FALSE & dd$session=='5c09zarp'])
mean(dd$ex_price[dd$asset==2  & dd$session=='5c09zarp'])
(18950-3320)/2
22790-8250-5940
7200-5755
(7200-5755)/4
3320/2
1660+5755
3320/4
315*8
rm(list = ls())
library("rjson")
library(ggplot2)
library(dplyr)
library(tidyverse)
library(xtable)
setwd("~/Desktop/jotarepos/capmout/a2c_ss")
files = list.files(pattern="*json")
protect_against_null <- function( x ) {
if( is.null(x) )
return( NA ) # Replace with whatever string you'd like.
else
return( x )
}
df<-NULL
dt<-NULL
nombre<-files[1]
d <- fromJSON(file = nombre)
#round time_active time_inactive pcode id status price
for (round in c(4:length(d))) {
for (asset in seq(4)){
quantos<-length(d[[round]][["exchange_data"]][[asset]][['orders']])
for (i in c(1:quantos)){
esta<-d[[round]][["exchange_data"]][[asset]][['orders']][[i]]
df<-rbind(df,c(round,esta[["time_entered"]],asset,esta[['pcode']],esta[['price']],esta[['is_bid']],esta[['id']],protect_against_null(esta[["time_inactive"]]),protect_against_null(esta[['status']])))#esta[["time_inactive"]],esta[['id']]))
}
market<-length(d[[round]][["exchange_data"]][[asset]][['trades']])
if(market==0) next
for (j in c(1:market)){
estm<-d[[round]][["exchange_data"]][[asset]][['trades']][[j]]
dt<-rbind(dt,c(round,estm[["timestamp"]],asset,estm[['taking_order_id']],estm[['making_order_ids']]))
}
}
}
df<-as.data.frame(df)
dt<-as.data.frame(dt)
names(df)<-c("round","time_entered","asset","pcode","price","bid","id","time_inactive","status")
names(dt)<-c("round","time_entered","asset","take_id","make_id")
df$round<-as.numeric(as.character(df$round))
df$time_entered<-as.character(df$time_entered)
df$time_inactive<-as.character(df$time_inactive)
df$status<-as.character(df$status)
df$time_entered<-as.numeric(paste(df$time_entered))
df$time_inactive<-as.numeric(paste(df$time_inactive))
df$asset<-as.numeric(as.character(df$asset))
df$price<-as.numeric(as.character(df$price))
df$pcode<-as.character(df$pcode)
df$id<-as.numeric(as.character(df$id))
dt<-as.data.frame(dt)
dt$round<-as.numeric(as.character(dt$round))
dt$asset<-as.numeric(as.character(dt$asset))
dt$take_id<-as.numeric(as.character(dt$take_id))
dt$make_id<-as.numeric(as.character(dt$make_id))
dt$time_entered<-as.numeric(as.character(dt$time_entered))
df$round<-df$round-3
dt$round<-dt$round-3
df= arrange(df, round, time_entered)
df$tiempo<-df$time_entered
d_tempora<- df %>% select(id,price)
dt$tiempo<-as.numeric(dt$time_entered)
dt<- dt %>% inner_join(d_tempora, by = c("make_id" = "id"))
colnames(dt)[7]<-"ex_price"
makers<- dt %>% select(make_id,ex_price)
takers<- dt %>% select(take_id,ex_price)
colnames(takers)<-colnames(makers)
makers<-rbind(makers,takers)
df<- df  %>% left_join(makers, by = c("id"= "make_id"))
#df$time_inactive[df$status=="CANCELED"]<-df$time_inactive[df$status=="CANCELED"]+7200
df$tre<-3 #1 refers to ABC 2 to A2B
df$session<-unlist(strsplit(nombre, split='.', fixed=TRUE))[1]
for(r in 2:length(unique(df$round))){
df$tiempo[df$round==r]<-df$tiempo[df$round==r]+max(df$tiempo[df$round==r-1])
dt$tiempo[dt$round==r]<-dt$tiempo[dt$round==r]+max(df$tiempo[df$round==r-1])
#df$time_inactive[df$round==r]<-df$time_inactive[df$round==r]+max(df$tiempo[df$round==r-1])
}
for(r in 2:length(unique(df$round))){
df$time_inactive[df$round==r]<-df$time_inactive[df$round==r]+max(df$tiempo[df$round==r-1])
}
dt$tre<-3
dt$session<-unlist(strsplit(nombre, split='.', fixed=TRUE))[1]
d_pcodes<- df %>% select(id,pcode)
dt<- dt %>% inner_join(d_pcodes, by = c("make_id" = "id"))
colnames(dt)[10] = "make_pcode"
dt<- dt %>% inner_join(d_pcodes, by = c("take_id" = "id"))
colnames(dt)[11] = "take_pcode"
d_bid<- df %>% select(id,bid)
dt<- dt %>% inner_join(d_bid, by = c("make_id" = "id"))
colnames(dt)[12] = "make_isbid"
save(df,file=paste("data_",df$session[1],".Rda",sep=""))
save(dt,file=paste("datatrades_",dt$session[1],".Rda",sep=""))
## Put all data together
rm(list = ls())
setwd("~/Desktop/jotarepos/capmout/clean")
#setwd("~/Desktop/jotarepos/capmout/a2c/clean")
files<-list.files(pattern="data_")
d<-NULL
for (f in files){
load(f)
d<-rbind(d,df)
}
files_t<-list.files(pattern="datatrades*")
dd<-NULL
for (f in files_t){
load(f)
dd<-rbind(dd,dt)
}
#load("~/Desktop/jotarepos/capm/Data/alldata.Rda")
save(d,file="alldata.Rda")
save(dd,file="alltrades.Rda")
rm(list = ls())
library(dplyr)
library(tidyverse)
library(xtable)
load("~/Desktop/jotarepos/capmout/clean/alldata.Rda")
d <- arrange(d, d$session, d$round, d$tiempo)
d$time_inactive[d$time_inactive>86400 & !is.na(d$time_inactive)]<-d$time_inactive[d$time_inactive>86400  & !is.na(d$time_inactive)]-86400
#d$time_inactive[d$time_inactive>86400 & !is.na(d$time_inactive)]<-d$time_inactive[d$time_inactive>86400  & !is.na(d$time_inactive)]-86400
#d$ex_price[!is.na(d$ex_price) & (d$time_inactive-d$tiempo>0.8)]<-NA
d$bb<-NA
d$bo<-NA
#d$ex_price[!is.na(d$ex_price) & (d$time_inactive-d$tiempo>0.8)]<-NA
for(sess in unique(d$session)){
for(activo in c(1:4)){
for(r in c(1:7)){
books<- d %>% filter(round==r &session==sess & asset==activo) %>% select(price, tiempo, time_inactive, bid, ex_price, status)
books$bb<-NA
books$bo<-NA
books$price[!is.na(books$ex_price)]<-books$ex_price[!is.na(books$ex_price)]
books$price[books$bid==FALSE]<-books$price[books$bid==FALSE]*-1
books$time_inactive[is.na(books$time_inactive)]<-max(books$tiempo)+10
books$time_inactive[books$status=="ACCEPTED_TAKER"]<-books$tiempo[books$status=="ACCEPTED_TAKER"]
for(l in c(1:dim(books)[1])){
t<-books$tiempo[l]
books$bb[l]<-max(books$price[books$tiempo<=t & books$time_inactive>=t])
}
books$price[books$bid==FALSE]<-books$price[books$bid==FALSE]*-1
books$price[books$bid==TRUE]<-10000
for(l in c(1:dim(books)[1])){
t<-books$tiempo[l]
books$bo[l]<-min(books$price[books$tiempo<=t & books$time_inactive>=t],na.rm=T)
}
d$bb[d$round==r &d$session==sess & d$asset==activo]<- books$bb
d$bo[d$round==r &d$session==sess & d$asset==activo]<- books$bo
}
}
}
d<-as.data.frame(d)
d$bb<-as.numeric(paste(d$bb))
d$bo<-as.numeric(paste(d$bo))
d$ex_price<-as.numeric(paste(d$ex_price))
d$price<-as.numeric(paste(d$price))
d$bb[d$bb<0]<-NA
d$bo[d$bo==10000]<-NA
d$spd<-(d$bo-d$bb)
d$spd_z<-d$spd
d$spd_z[is.na(d$spd_z)]<-0
rango<- 4
descuento<- 0.99
data<-NULL
for(sess in unique(d$session)){
tre<-max(d$tre[d$session==sess])
precio<-NA
for(r in c(1:7)){
t_0<-min(d$tiempo[d$round==r & d$session==sess])
t_max<-max(d$tiempo[d$round==r & d$session==sess])
precio<-NA
dete<-0
dete_a<-0
for(activo in c(1:4)){
i<-0
precio<-NA
dete<-0
dete_a<-0
books<- d %>% filter(round==r &session==sess & asset==activo) %>% select(price, tiempo, time_inactive, bid, ex_price, status)
books$price[!is.na(books$ex_price)]<-books$ex_price[!is.na(books$ex_price)]
books$time_inactive[is.na(books$time_inactive)]<-max(books$tiempo)+10
books$time_inactive[books$status=="ACCEPTED_TAKER"]<-books$tiempo[books$status=="ACCEPTED_TAKER"]
l<-t_0+rango
while (l<=t_max){
i<-i+1
descuento_compra<-0
ordenes_compra<-0
ordenes_venta<-0
dete<-0
precio<-NA
spr<-0
bb<-NA
bo<-NA
libro<- books %>% filter(tiempo<=l & time_inactive>l-rango)
if(dim(libro)[1]>0){
libro_compra<- libro %>% filter(bid==TRUE)
libro_venta<-  libro %>% filter(bid==FALSE)
if(dim(libro_compra)[1]>0){
bb<-max(libro_compra$price)
}
if(dim(libro_venta)[1]>0){
bo<-min(libro_venta$price)
}
spr<-mean(c(bo,bb),na.rm = T)
if(dim(libro_compra)[1]>0){
ordenes_compra<-sum(descuento^(abs(libro_compra$price-spr)),na.rm=T)
}
if(dim(libro_venta)[1]>0){
ordenes_venta<-sum(descuento^(abs(libro_venta$price-spr)),na.rm=T)
}
precio<-mean(libro$ex_price[(libro$time_inactive-libro$tiempo<1)],na.rm = T)
if (!is.na(precio)){
dete<-length(libro$ex_price[libro$time_inactive-libro$tiempo<1 & libro$bid==TRUE])- length(libro$ex_price[libro$time_inactive-libro$tiempo<1 & libro$bid!=TRUE])
dete_a<-dete_a+dete
}
data<-rbind(data,cbind(sess,tre,r,activo,i,ordenes_compra,ordenes_venta,bb,bo,precio,dete,dete_a))
}
l<-l+rango
}
}
}
}
data<-as.data.frame(data)
data$bb<-as.numeric(paste(data$bb))
data$bo<-as.numeric(paste(data$bo))
data$dete<-as.numeric(paste(data$dete))
data$dete_a<-as.numeric(paste(data$dete_a))
data$i<-as.numeric(paste(data$i))
data$activo<-as.numeric(paste(data$activo))
data$r<-as.numeric(paste(data$r))
data$tre<-as.numeric(paste(data$tre))
data$ordenes_compra<-as.numeric(paste(data$ordenes_compra))
data$ordenes_venta<-as.numeric(paste(data$ordenes_venta))
data$z<-data$ordenes_compra-data$ordenes_venta
data$precio<-as.numeric(paste(data$precio))
data <- arrange(data, data$sess, data$activo, data$r, data$i)
data$dt[2:length(data$r)]<-data$r[2:length(data$r)]-data$r[1:length(data$r)-1]
data$dt[1]<-0
write.csv(data,file="detf.csv",row.names=FALSE)
library(dplyr)
library(tidyverse)
library(xtable)
library(here)
d<-read.csv(here("detf.csv"),sep=",",header=T, stringsAsFactors = FALSE)
dprice<- d %>%
group_by(sess, tre, r, activo)  %>%
summarize(prices=  mean(precio,na.rm = T))
plot(dprice$prices[dprice$activo==2 & dprice$tre==1],dprice$prices[dprice$activo==3 & dprice$tre==1] )
abline(0,1)
points(dprice$prices[dprice$activo==2 & dprice$tre==2],dprice$prices[dprice$activo==3 & dprice$tre==2],col="blue")
points(dprice$prices[dprice$activo==2 & dprice$tre==3],dprice$prices[dprice$activo==3 & dprice$tre==3],col="red")
dprice2<- d %>%
group_by(tre, r, activo)  %>%
summarize(prices=  mean(precio,na.rm = T),
ordenes= mean(z,na.rm = T)
)
pdf("sum_prices.pdf")
plot(dprice2$r[dprice2$activo==2 & dprice2$tre==1],dprice2$prices[dprice2$activo==3 & dprice2$tre==1]-dprice2$prices[dprice2$activo==2 & dprice2$tre==1],type="l",ylim=c(-10,40),xlab="market",ylab=expression('P'[C] - 'P'[B]),lwd=2)
lines(dprice2$r[dprice2$activo==2 & dprice2$tre==2],dprice2$prices[dprice2$activo==3 & dprice2$tre==2]-dprice2$prices[dprice2$activo==2 & dprice2$tre==2],col="blue",lwd=2,lty=2)
lines(dprice2$r[dprice2$activo==2 & dprice2$tre==3],dprice2$prices[dprice2$activo==3 & dprice2$tre==3]-dprice2$prices[dprice2$activo==2 & dprice2$tre==3],col="red",lwd=2,lty=3)
abline(h=0,lty=2,col="gray")
legend(1.1,19,c("ABC","A2C","A2C short"),col=c("black", "blue","red"),lty=c(1,2,3),cex=.9,bty = "n")
dev.off()
pdf("sum_ordenes.pdf")
plot(dprice2$r[dprice2$activo==2 & dprice2$tre==1],dprice2$ordenes[dprice2$activo==3 & dprice2$tre==1]-dprice2$ordenes[dprice2$activo==2 & dprice2$tre==1],type="l",ylim=c(-2,5),xlab="market",ylab=expression('z'[C] - 'z'[B]),lwd=2)
lines(dprice2$r[dprice2$activo==2 & dprice2$tre==2],dprice2$ordenes[dprice2$activo==3 & dprice2$tre==2]-dprice2$ordenes[dprice2$activo==2 & dprice2$tre==2],col="blue",lwd=2,lty=2)
lines(dprice2$r[dprice2$activo==2 & dprice2$tre==3],dprice2$ordenes[dprice2$activo==3 & dprice2$tre==3]-dprice2$ordenes[dprice2$activo==2 & dprice2$tre==3],col="red",lwd=2,lty=3)
abline(h=0,lty=2,col="gray")
legend(5,4,c("ABC","A2C","A2C short"),col=c("black", "blue","red"),lty=c(1,2,3),cex=.9,bty = "n")
dev.off()
